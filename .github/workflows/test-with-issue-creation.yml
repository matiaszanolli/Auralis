name: Tests with Auto-Issue Creation

on:
  push:
    branches: [ master, develop ]
    paths:
      - 'auralis/**'
      - 'auralis-web/**'
      - 'tests/**'
      - 'requirements.txt'
      - '.github/workflows/test-with-issue-creation.yml'
  pull_request:
    branches: [ master ]
  schedule:
    # Run nightly to catch flaky tests
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  contents: read
  issues: write  # Required to create/update issues
  checks: write

jobs:
  test-backend:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.12', '3.13']
      fail-fast: false  # Continue testing other versions even if one fails

    steps:
    - uses: actions/checkout@v4

    - name: Setup Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libsndfile1 ffmpeg portaudio19-dev protobuf-compiler

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel maturin
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-asyncio pytest-timeout
        pip install PyGithub  # For issue creation script

    - name: Build and install Rust DSP module
      run: |
        cd vendor/auralis-dsp
        maturin develop
      env:
        PYO3_USE_ABI3_FORWARD_COMPATIBILITY: 1

    - name: Run backend tests with JUnit output
      id: backend_tests
      continue-on-error: true  # Don't fail workflow, we'll create issues instead
      run: |
        python -m pytest tests/backend/ -v \
          --cov=auralis-web/backend \
          --cov-report=xml \
          --cov-report=term-missing \
          --junitxml=test-results-backend.xml \
          --timeout=300 \
          -m "not slow"

    - name: Run core tests with JUnit output
      id: core_tests
      continue-on-error: true
      run: |
        python -m pytest tests/auralis/ -v \
          --junitxml=test-results-core.xml \
          --timeout=300 \
          -m "not slow"

    - name: Create issues from backend test failures
      if: always() && steps.backend_tests.outcome == 'failure'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        python .github/scripts/create_test_issues.py \
          --junit-xml test-results-backend.xml \
          --repo ${{ github.repository }}

    - name: Create issues from core test failures
      if: always() && steps.core_tests.outcome == 'failure'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        python .github/scripts/create_test_issues.py \
          --junit-xml test-results-core.xml \
          --repo ${{ github.repository }}

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-py${{ matrix.python-version }}
        path: |
          test-results-*.xml
          coverage.xml

    - name: Upload coverage
      uses: codecov/codecov-action@v4
      if: matrix.python-version == '3.13'
      with:
        file: ./coverage.xml
        flags: backend
        name: backend-py${{ matrix.python-version }}
        fail_ci_if_error: false

    # Fail the workflow if tests failed (after creating issues)
    - name: Check test results
      if: steps.backend_tests.outcome == 'failure' || steps.core_tests.outcome == 'failure'
      run: |
        echo "::error::Tests failed. Issues have been created for failures."
        exit 1

  test-frontend:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install dependencies
      working-directory: auralis-web/frontend
      run: npm install

    - name: Install PyGithub for issue creation
      run: pip install PyGithub

    - name: Run frontend tests with JUnit output
      id: frontend_tests
      working-directory: auralis-web/frontend
      continue-on-error: true
      env:
        NODE_OPTIONS: --max-old-space-size=2048
      run: |
        npm run test:memory -- \
          --coverage \
          --reporter=junit \
          --outputFile=../../test-results-frontend.xml

    - name: Create issues from frontend test failures
      if: always() && steps.frontend_tests.outcome == 'failure'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        if [ -f test-results-frontend.xml ]; then
          python .github/scripts/create_test_issues.py \
            --junit-xml test-results-frontend.xml \
            --repo ${{ github.repository }}
        else
          echo "No JUnit XML found - skipping issue creation"
        fi

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-frontend
        path: |
          test-results-frontend.xml
          auralis-web/frontend/coverage/

    - name: Check test results
      if: steps.frontend_tests.outcome == 'failure'
      run: |
        echo "::error::Frontend tests failed. Issues have been created for failures."
        exit 1

  # Summary job that shows overall status
  test-summary:
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend]
    if: always()

    steps:
    - name: Check overall status
      run: |
        if [ "${{ needs.test-backend.result }}" == "failure" ] || [ "${{ needs.test-frontend.result }}" == "failure" ]; then
          echo "::error::Some tests failed. Check the issues created for details."
          exit 1
        fi
        echo "âœ“ All tests passed!"
